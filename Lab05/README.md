Lab05
================
Jiayi Nie

``` r
library(tidyverse)
```

    ## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──

    ## ✓ ggplot2 3.3.5     ✓ purrr   0.3.4
    ## ✓ tibble  3.1.3     ✓ dplyr   1.0.7
    ## ✓ tidyr   1.1.3     ✓ stringr 1.4.0
    ## ✓ readr   2.0.1     ✓ forcats 0.5.1

    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(data.table)
```

    ## 
    ## Attaching package: 'data.table'

    ## The following objects are masked from 'package:dplyr':
    ## 
    ##     between, first, last

    ## The following object is masked from 'package:purrr':
    ## 
    ##     transpose

``` r
library(leaflet)
```

``` r
met<- data.table::fread("../Lab04/met_all.gz")

# Download the data
stations <- fread("ftp://ftp.ncdc.noaa.gov/pub/data/noaa/isd-history.csv")
stations[, USAF := as.integer(USAF)]
```

    ## Warning in eval(jsub, SDenv, parent.frame()): NAs introduced by coercion

``` r
# Dealing with NAs and 999999
stations[, USAF   := fifelse(USAF == 999999, NA_integer_, USAF)]
stations[, CTRY   := fifelse(CTRY == "", NA_character_, CTRY)]
stations[, STATE  := fifelse(STATE == "", NA_character_, STATE)]

# Selecting the three relevant columns, and keeping unique records
stations <- unique(stations[, list(USAF, CTRY, STATE)])

# Dropping NAs
stations <- stations[!is.na(USAF)]

# Removing duplicates
stations[, n := 1:.N, by = .(USAF)]
stations <- stations[n == 1,][, n := NULL]
```

merging the data

``` r
met <- merge(
  # Data
  x     = met,      
  y     = stations, 
  # List of variables to match
  by.x  = "USAFID",
  by.y  = "USAF", 
  # Which obs to keep?
  all.x = TRUE,      
  all.y = FALSE
  )
```

## Question1: Representative station for the US

What is the median station in terms of temperature, wind speed, and
atmospheric pressure? Look for the three weather stations that best
represent continental US using the quantile() function. Do these three
coincide?

First, generate a representative version of each station. We will use
the averages (median could also be a good way to represent it, but it
will depend on the case).

``` r
station_averages <- met[,.(
  temp      = mean(temp, na.rm = TRUE),
  wind.sp   = mean(wind.sp, na.rm = TRUE),
  atm.press = mean(atm.press, na.rm = TRUE),
  lon = mean(lon, na.rm = TRUE),
  lat = mean(lat, na.rm = TRUE)
), by = .(USAFID)]
```

Now, we need to identify the median per variable

``` r
medians <- station_averages[,.(
  temp_50      = quantile(temp, probs = .5, na.rm = TRUE),
  wind.sp_50   = quantile(wind.sp, probs = .5, na.rm = TRUE),
  atm.press_50 = quantile(atm.press, probs = .5, na.rm = TRUE)
)]
```

Now we can find the stations that are the closest to these. (hint:
which.min())

``` r
station_averages[, temp_dist := abs(temp - medians$temp_50)]
median_temp_station <- station_averages[order(temp_dist)][1]
median_temp_station
```

    ##    USAFID     temp  wind.sp atm.press     lon    lat   temp_dist
    ## 1: 720458 23.68173 1.209682       NaN -82.637 37.751 0.002328907

``` r
station_averages[, wind.sp_dist := abs(wind.sp - medians$wind.sp_50)]
median_wind.sp_station <- station_averages[order(wind.sp_dist)][1]
median_wind.sp_station
```

    ##    USAFID     temp  wind.sp atm.press     lon    lat temp_dist wind.sp_dist
    ## 1: 720929 17.43278 2.461838       NaN -91.981 45.506  6.251284            0

``` r
station_averages[, atm.press_dist := abs(temp - medians$atm.press_50)]
median_atm.press_station <- station_averages[order(atm.press_dist)][1]
median_atm.press_station
```

    ##    USAFID     temp  wind.sp atm.press      lon    lat temp_dist wind.sp_dist
    ## 1: 723805 37.62539 3.532935  1005.207 -114.618 34.768  13.94133     1.071097
    ##    atm.press_dist
    ## 1:       977.0658

720458,720929,722238 respectively so these stations are not coincide.

## Question2: Representative station per state

We first need to recover the state variable, by merging

``` r
station_averages <- merge(
  x = station_averages, y = stations,
  by.x = "USAFID", by.y = "USAF",
  all.x = TRUE, all.y = FALSE
  )
```

Now we can compute the median per state

``` r
station_averages[, temp_50 := quantile(temp, probs = .5, na.rm = TRUE), by = STATE]
station_averages[, wind.sp_50 := quantile(wind.sp, probs = .5, na.rm = TRUE), by = STATE]
station_averages[, atm.press_50 := quantile(atm.press, probs = .5, na.rm = TRUE), by = STATE]
```

Now, the euclidean distance… \(\sqrt{\sum_i(x_i - y_i)^2}\)

``` r
station_averages[, eudist := sqrt(
  (temp - temp_50)^2 + (wind.sp - wind.sp_50)^2 + (atm.press - atm.press_50)^2
  )]
station_averages_state <- station_averages[ , .SD[which.min(eudist)], by = STATE]

station_averages_state
```

    ##     STATE USAFID     temp  wind.sp atm.press        lon      lat temp_dist
    ##  1:    CA 722970 22.76040 2.325982  1012.710 -118.14652 33.81264 0.9236572
    ##  2:    TX 722416 29.75394 3.539980  1012.331  -98.04599 29.70899 6.0698790
    ##  3:    MI 725395 20.44096 2.357275  1015.245  -84.46697 42.26697 3.2431039
    ##  4:    SC 723190 25.73726 2.253408  1015.116  -82.71000 34.49800 2.0532044
    ##  5:    IL 725440 22.84806 2.566829  1014.760  -90.52032 41.46325 0.8360010
    ##  6:    MO 723495 24.31621 2.550940  1014.296  -94.49501 37.15200 0.6321463
    ##  7:    AR 723407 25.86949 2.208652  1014.575  -90.64600 35.83100 2.1854323
    ##  8:    OR 725895 18.79793 2.307326  1014.726 -121.72405 42.14705 4.8861299
    ##  9:    GA 723160 26.59746 1.684538  1014.985  -82.50700 31.53600 2.9134022
    ## 10:    MN 726550 19.11831 2.832794  1015.319  -94.05102 45.54301 4.5657541
    ## 11:    AL 722286 26.35793 1.675828  1014.909  -87.61600 33.21200 2.6738730
    ## 12:    IN 725327 22.40044 2.547951  1015.145  -87.00600 41.45300 1.2836192
    ## 13:    NC 723174 24.95288 1.744838  1015.350  -79.47700 36.04700 1.2688166
    ## 14:    VA 724016 24.29327 1.588105  1014.946  -78.45499 38.13701 0.6092071
    ## 15:    IA 725480 21.43686 2.764312  1014.814  -92.40088 42.55358 2.2472026
    ## 16:    PA 725130 21.69177 1.970192  1015.125  -75.72500 41.33380 1.9922887
    ## 17:    NE 725560 21.80411 3.428358  1014.386  -97.43479 41.98568 1.8799508
    ## 18:    ID 725867 20.81272 2.702517  1012.802 -113.76605 42.54201 2.8713440
    ## 19:    WI 726452 19.21728 2.411747  1015.180  -89.83701 44.35900 4.4667828
    ## 20:    WV 724176 21.94072 1.649151  1015.982  -79.91600 39.64300 1.7433407
    ## 21:    MD 724057 25.00877 2.033233  1014.497  -76.16996 39.47174 1.3247127
    ## 22:    AZ 722745 30.31538 3.307632  1010.144 -110.88300 32.16695 6.6313167
    ## 23:    OK 723545 27.03555 3.852697  1012.711  -97.08896 36.16199 3.3514940
    ## 24:    WY 726650 19.75554 4.243727  1013.527 -105.54099 44.33905 3.9285171
    ## 25:    LA 722486 28.16413 1.592840  1014.544  -92.04098 32.51596 4.4800738
    ## 26:    KY 724240 23.79463 2.450704  1015.375  -85.96723 37.90032 0.1105710
    ## 27:    FL 722106 27.52774 2.711121  1015.322  -81.86101 26.58501 3.8436793
    ## 28:    CO 724767 21.97732 2.780364  1014.082 -108.62600 37.30699 1.7067344
    ## 29:    OH 724298 21.79537 2.771958  1015.248  -84.02700 40.70800 1.8886908
    ## 30:    NJ 724090 23.47238 2.148606  1015.095  -74.35016 40.03300 0.2116829
    ## 31:    NM 722686 26.00522 4.503611  1012.742 -103.31565 34.38358 2.3211638
    ## 32:    KS 724580 24.01181 3.548029  1013.449  -97.65090 39.55090 0.3277524
    ## 33:    VT 726115 18.60548 1.101301  1014.985  -72.51800 43.34400 5.0785811
    ## 34:    MS 722358 26.54093 1.747426  1014.722  -90.47100 31.18298 2.8568706
    ## 35:    CT 725087 22.57539 2.126514  1014.534  -72.65098 41.73601 1.1086682
    ## 36:    NV 725805 25.21743 3.101560  1012.461 -118.56898 40.06799 1.5333745
    ## 37:    UT 725755 24.31031 3.361211  1012.243 -111.96637 41.11737 0.6262500
    ## 38:    SD 726590 19.95928 3.550722  1014.284  -98.41344 45.44377 3.7247800
    ## 39:    TN 723346 24.59407 1.493531  1015.144  -88.91700 35.59302 0.9100071
    ## 40:    NY 725194 20.37207 2.444051  1015.327  -77.05599 42.64299 3.3119910
    ## 41:    RI 725079 22.27697 2.583469  1014.620  -71.28300 41.53300 1.4070879
    ## 42:    MA 725064 21.40933 2.786213  1014.721  -70.72900 41.91000 2.2747284
    ## 43:    DE 724180 24.56026 2.752929  1015.046  -75.60600 39.67400 0.8761984
    ## 44:    NH 726050 19.86188 1.732752  1014.487  -71.50245 43.20409 3.8221833
    ## 45:    ME 726077 18.49969 2.337241  1014.475  -68.36677 44.45000 5.1843701
    ## 46:    MT 726798 19.47014 4.445783  1014.072 -110.44004 45.69800 4.2139153
    ##     STATE USAFID     temp  wind.sp atm.press        lon      lat temp_dist
    ##     wind.sp_dist atm.press_dist CTRY  temp_50 wind.sp_50 atm.press_50
    ##  1:   0.13585606       991.9307   US 22.66268   2.565445     1012.557
    ##  2:   1.07814202       984.9372   US 29.75188   3.413737     1012.460
    ##  3:   0.10456335       994.2502   US 20.51970   2.273423     1014.927
    ##  4:   0.20843011       988.9539   US 25.80545   1.696119     1015.281
    ##  5:   0.10499086       991.8431   US 22.43194   2.237622     1014.760
    ##  6:   0.08910173       990.3749   US 23.95109   2.453547     1014.522
    ##  7:   0.25318602       988.8217   US 26.24296   1.938625     1014.591
    ##  8:   0.15451193       995.8932   US 17.98061   2.011436     1015.269
    ##  9:   0.77729997       988.0937   US 26.70404   1.495596     1015.208
    ## 10:   0.37095652       995.5728   US 19.63017   2.617071     1015.042
    ## 11:   0.78600982       988.3332   US 26.33664   1.662132     1014.959
    ## 12:   0.08611334       992.2907   US 22.25059   2.344333     1015.063
    ## 13:   0.71699988       989.7383   US 24.72953   1.627306     1015.420
    ## 14:   0.87373310       990.3979   US 24.37799   1.653032     1015.158
    ## 15:   0.30247433       993.2543   US 21.33461   2.680875     1014.964
    ## 16:   0.49164643       992.9994   US 21.69177   1.784167     1015.435
    ## 17:   0.96652027       992.8870   US 21.87354   3.192539     1014.332
    ## 18:   0.24067862       993.8784   US 20.56798   2.568944     1012.855
    ## 19:   0.05009126       995.4739   US 18.85524   2.053283     1014.893
    ## 20:   0.81268709       992.7504   US 21.94446   1.633487     1015.762
    ## 21:   0.42860531       989.6824   US 24.89883   1.883499     1014.824
    ## 22:   0.84579394       984.3758   US 30.32372   3.074359     1010.144
    ## 23:   1.39085916       987.6556   US 27.14427   3.852697     1012.567
    ## 24:   1.78188923       994.9356   US 19.80699   3.873392     1013.157
    ## 25:   0.86899784       986.5270   US 27.87430   1.592840     1014.593
    ## 26:   0.01113371       990.8965   US 23.88844   1.895486     1015.245
    ## 27:   0.24928306       987.1634   US 27.57325   2.705069     1015.335
    ## 28:   0.31852617       992.7138   US 21.49638   3.098777     1013.334
    ## 29:   0.31011974       992.8958   US 22.02062   2.554397     1015.351
    ## 30:   0.31323188       991.2188   US 23.47238   2.148606     1014.825
    ## 31:   2.04177257       988.6859   US 24.94447   3.776083     1012.525
    ## 32:   1.08619103       990.6793   US 24.21220   3.680613     1013.389
    ## 33:   1.36053682       996.0857   US 18.61379   1.408247     1014.792
    ## 34:   0.71441147       988.1502   US 26.69258   1.636392     1014.836
    ## 35:   0.33532437       992.1158   US 22.36880   2.101801     1014.810
    ## 36:   0.63972235       989.4737   US 24.56293   3.035050     1012.204
    ## 37:   0.89937340       990.3808   US 24.35182   3.145427     1011.972
    ## 38:   1.08888409       994.7319   US 20.35662   3.665638     1014.398
    ## 39:   0.96830647       990.0971   US 24.88657   1.576035     1015.144
    ## 40:   0.01778649       994.3191   US 20.40674   2.304075     1014.887
    ## 41:   0.12163090       992.4142   US 22.53551   2.583469     1014.728
    ## 42:   0.32437547       993.2818   US 21.30662   2.710944     1014.751
    ## 43:   0.29109156       990.1309   US 24.56026   2.752929     1015.046
    ## 44:   0.72908585       994.8293   US 19.55054   1.563826     1014.689
    ## 45:   0.12459727       996.1915   US 18.79016   2.237210     1014.399
    ## 46:   1.98394520       995.2210   US 19.15492   4.151737     1014.185
    ##     wind.sp_dist atm.press_dist CTRY  temp_50 wind.sp_50 atm.press_50
    ##         eudist
    ##  1: 0.30049511
    ##  2: 0.18029339
    ##  3: 0.33875622
    ##  4: 0.58529642
    ##  5: 0.53059335
    ##  6: 0.44048404
    ##  7: 0.46112989
    ##  8: 1.02527449
    ##  9: 0.31157584
    ## 10: 0.62096399
    ## 11: 0.05608376
    ## 12: 0.26577311
    ## 13: 0.26213187
    ## 14: 0.23665335
    ## 15: 0.19926933
    ## 16: 0.36234584
    ## 17: 0.25159903
    ## 18: 0.28377685
    ## 19: 0.58447881
    ## 20: 0.22082482
    ## 21: 0.37630511
    ## 22: 0.23342190
    ## 23: 0.18052457
    ## 24: 0.52649035
    ## 25: 0.29399685
    ## 26: 0.57786362
    ## 27: 0.04772342
    ## 28: 0.94422827
    ## 29: 0.32969606
    ## 30: 0.26971491
    ## 31: 1.30437627
    ## 32: 0.24751336
    ## 33: 0.36261055
    ## 34: 0.21966149
    ## 35: 0.34635143
    ## 36: 0.70623784
    ## 37: 0.34923813
    ## 38: 0.42910869
    ## 39: 0.30391254
    ## 40: 0.46256996
    ## 41: 0.28039594
    ## 42: 0.13084377
    ## 43: 0.00000000
    ## 44: 0.40778497
    ## 45: 0.31653296
    ## 46: 0.44582815
    ##         eudist

## Question 3: In the middle?

``` r
#calculate median for lon and lat per state
station_averages[, lon_50 := quantile(lon, probs = .5, na.rm = TRUE), by = STATE]
station_averages[, lat_50 := quantile(lat, probs = .5, na.rm = TRUE), by = STATE]

#now calculate the distance
station_averages[, latlon_dis := sqrt(
  (lat-lat_50)^2 + (lon - lon_50)^2
)]

midpoint<- station_averages[, .SD[which.min(latlon_dis)],by =STATE]

midpoint
```

    ##     STATE USAFID     temp   wind.sp atm.press        lon      lat    temp_dist
    ##  1:    CA 723898 28.40804 2.8102319  1011.520 -119.62800 36.31899  4.723983662
    ##  2:    TX 722575 30.30429       NaN  1012.605  -97.68315 31.08315  6.620233696
    ##  3:    MI 725405 19.91292 1.9441737       NaN  -84.68800 43.32200  3.771135505
    ##  4:    SC 720603 26.32987 1.5150567       NaN  -80.56700 34.28300  2.645809723
    ##  5:    IL 724397 22.03413 3.4911565  1015.253  -88.94836 40.48271  1.649932249
    ##  6:    MO 724453 22.13591 3.1443238  1014.957  -93.18299 38.70400  1.548144422
    ##  7:    AR 720401 25.83741 0.5805530       NaN  -92.45000 35.60000  2.153350187
    ##  8:    OR 725970 23.45945 1.9420802  1013.924 -122.87087 42.37773  0.224612669
    ##  9:    WA 720388 19.35326 0.5583820       NaN -122.28683 47.10383  4.330800806
    ## 10:    GA 722175 26.53220 1.8966816  1015.247  -83.59972 32.63325  2.848138076
    ## 11:    MN 726569 19.56518 2.1263578       NaN  -94.38213 44.85913  4.118883515
    ## 12:    AL 722265 27.10960 1.8515312  1014.800  -86.35061 32.38300  3.425539923
    ## 13:    IN 720961 20.94252 2.0536596       NaN  -86.37500 40.71100  2.741535659
    ## 14:    NC 722201 24.18637 0.9103853       NaN  -79.10100 35.58208  0.502306540
    ## 15:    VA 720498 24.92926 2.0898389  1016.447  -77.51700 37.40000  1.245200026
    ## 16:    IA 725466 21.79148 2.7225459       NaN  -93.56600 41.69100  1.892581446
    ## 17:    PA 725118 24.58627 2.0405376  1015.104  -76.85100 40.21700  0.902206861
    ## 18:    NE 725520 21.85539 3.6775510  1015.050  -98.31427 40.96155  1.828671140
    ## 19:    ID 725865 17.08795 3.7480456       NaN -114.29974 43.50026  6.596111351
    ## 20:    WI 726452 19.21728 2.4117467  1015.180  -89.83701 44.35900  4.466782811
    ## 21:    WV 720328 21.94820 1.6178231       NaN  -80.27400 39.00000  1.735861035
    ## 22:    MD 724067 24.18765 1.6004804       NaN  -76.41667 39.33223  0.503591127
    ## 23:    AZ 722783 34.84379 2.6428760  1008.210 -111.73290 33.46688 11.159731616
    ## 24:    OK 723540 26.70174 4.1168113  1013.747  -97.38319 35.41690  3.017676124
    ## 25:    WY 726720 21.70287 3.8003344  1012.771 -108.45695 43.06440  1.981189476
    ## 26:    LA 720468 26.89874 1.1130356       NaN  -92.09900 30.55800  3.214682905
    ## 27:    KY 720448 23.52994 1.6049055       NaN  -84.77000 37.57800  0.154117766
    ## 28:    FL 722011 27.56952 2.6740741  1016.063  -81.43700 28.29000  3.885463649
    ## 29:    CO 726396 12.93812 2.5374887       NaN -105.51004 39.05000 10.745938186
    ## 30:    OH 720928 21.87803 2.0763441       NaN  -83.11500 40.28000  1.806032328
    ## 31:    NJ 724090 23.47238 2.1486061  1015.095  -74.35016 40.03300  0.211682876
    ## 32:    NM 722677 21.33037 4.9883663  1015.128 -105.66201 35.00300  2.353693380
    ## 33:    KS 724509 23.67510 4.0668332  1013.863  -97.27500 38.06763  0.008959632
    ## 34:    ND 720867 18.20367 4.2037684       NaN -100.02400 48.39000  5.480389509
    ## 35:    VT 726114 17.46999 1.1657614  1014.792  -72.61400 44.53400  6.214068914
    ## 36:    MS 722350 27.03108 2.0681041  1014.575  -90.07897 32.32020  3.347022947
    ## 37:    CT 725027 21.87299 1.6481552  1014.760  -72.82800 41.51000  1.811065843
    ## 38:    NV 724770 21.37610 3.3832432  1012.475 -116.00502 39.60100  2.307963616
    ## 39:    UT 725724 24.39332 2.7791506  1012.675 -111.72300 40.21900  0.709265542
    ## 40:    SD 726560 20.55785 4.5733734  1013.479 -100.28500 44.38101  3.126206351
    ## 41:    TN 723273 25.01262 1.7828603  1004.715  -86.52000 36.00900  1.328563182
    ## 42:    NY 725145 19.13882 2.0224490  1016.326  -74.79500 41.70103  4.545242228
    ## 43:    RI 725074 24.45822 4.7099462       NaN  -71.41200 41.59700  0.774161791
    ## 44:    MA 725068 20.83820 1.3823436  1014.377  -71.02100 41.87600  2.845858760
    ## 45:    DE 724088 24.72840 3.0324747  1014.860  -75.46697 39.13291  1.044341502
    ## 46:    NH 726155 19.96899 1.9610188  1014.689  -71.43251 43.56721  3.715066985
    ## 47:    ME 726073 18.82098 1.4142598  1015.944  -69.66723 44.53300  4.863078307
    ## 48:    MT 726770 22.99419 4.1517371  1013.286 -108.54002 45.80547  0.689869918
    ##     STATE USAFID     temp   wind.sp atm.press        lon      lat    temp_dist
    ##     wind.sp_dist atm.press_dist CTRY  temp_50 wind.sp_50 atm.press_50
    ##  1:   0.34839399       986.2831   US 22.66268   2.565445     1012.557
    ##  2:          NaN       984.3869   US 29.75188   3.413737     1012.460
    ##  3:   0.51766421       994.7782   US 20.51970   2.273423     1014.927
    ##  4:   0.94678125       988.3613   US 25.80545   1.696119     1015.281
    ##  5:   1.02931853       992.6570   US 22.43194   2.237622     1014.760
    ##  6:   0.68248586       992.5552   US 23.95109   2.453547     1014.522
    ##  7:   1.88128490       988.8537   US 26.24296   1.938625     1014.591
    ##  8:   0.51975778       991.2317   US 17.98061   2.011436     1015.269
    ##  9:   1.90345591       995.3379   US 19.24684   1.268571           NA
    ## 10:   0.56515632       988.1590   US 26.70404   1.495596     1015.208
    ## 11:   0.33548011       995.1260   US 19.63017   2.617071     1015.042
    ## 12:   0.61030678       987.5815   US 26.33664   1.662132     1014.959
    ## 13:   0.40817830       993.7486   US 22.25059   2.344333     1015.063
    ## 14:   1.55145260       990.5048   US 24.72953   1.627306     1015.420
    ## 15:   0.37199903       989.7619   US 24.37799   1.653032     1015.158
    ## 16:   0.26070798       992.8997   US 21.33461   2.680875     1014.964
    ## 17:   0.42130030       990.1049   US 21.69177   1.784167     1015.435
    ## 18:   1.21571308       992.8358   US 21.87354   3.192539     1014.332
    ## 19:   1.28620767       997.6032   US 20.56798   2.568944     1012.855
    ## 20:   0.05009126       995.4739   US 18.85524   2.053283     1014.893
    ## 21:   0.84401481       992.7430   US 21.94446   1.633487     1015.762
    ## 22:   0.86135755       990.5035   US 24.89883   1.883499     1014.824
    ## 23:   0.18103805       979.8474   US 30.32372   3.074359     1010.144
    ## 24:   1.65497334       987.9894   US 27.14427   3.852697     1012.567
    ## 25:   1.33849651       992.9883   US 19.80699   3.873392     1013.157
    ## 26:   1.34880238       987.7924   US 27.87430   1.592840     1014.593
    ## 27:   0.85693245       991.1612   US 23.88844   1.895486     1015.245
    ## 28:   0.21223614       987.1216   US 27.57325   2.705069     1015.335
    ## 29:   0.07565077      1001.7530   US 21.49638   3.098777     1013.334
    ## 30:   0.38549385       992.8131   US 22.02062   2.554397     1015.351
    ## 31:   0.31323188       991.2188   US 23.47238   2.148606     1014.825
    ## 32:   2.52652840       993.3608   US 24.94447   3.776083     1012.525
    ## 33:   1.60499523       991.0160   US 24.21220   3.680613     1013.389
    ## 34:   1.74193045       996.4875   US 18.52849   3.956459           NA
    ## 35:   1.29607654       997.2212   US 18.61379   1.408247     1014.792
    ## 36:   0.39373379       987.6601   US 26.69258   1.636392     1014.836
    ## 37:   0.81368278       992.8182   US 22.36880   2.101801     1014.810
    ## 38:   0.92140531       993.3151   US 24.56293   3.035050     1012.204
    ## 39:   0.31731264       990.2978   US 24.35182   3.145427     1011.972
    ## 40:   2.11153544       994.1333   US 20.35662   3.665638     1014.398
    ## 41:   0.67897767       989.6785   US 24.88657   1.576035     1015.144
    ## 42:   0.43938896       995.5523   US 20.40674   2.304075     1014.887
    ## 43:   2.24810830       990.2329   US 22.53551   2.583469     1014.728
    ## 44:   1.07949431       993.8529   US 21.30662   2.710944     1014.751
    ## 45:   0.57063677       989.9627   US 24.56026   2.752929     1015.046
    ## 46:   0.50081911       994.7222   US 19.55054   1.563826     1014.689
    ## 47:   1.04757817       995.8702   US 18.79016   2.237210     1014.399
    ## 48:   1.68989915       991.6970   US 19.15492   4.151737     1014.185
    ##     wind.sp_dist atm.press_dist CTRY  temp_50 wind.sp_50 atm.press_50
    ##         eudist     lon_50   lat_50  latlon_dis
    ##  1:  5.8433023 -119.84200 36.02904 0.360369823
    ##  2:        NaN  -97.68315 31.10600 0.022846902
    ##  3:        NaN  -84.68800 43.06700 0.255000000
    ##  4:        NaN  -80.75853 34.18450 0.215374251
    ##  5:  1.4046440  -88.86202 40.38787 0.128251898
    ##  6:  1.9902499  -92.69100 38.59100 0.504804084
    ##  7:        NaN  -92.59000 35.33300 0.301475239
    ##  8:  5.6420036 -123.11743 42.27219 0.268205928
    ##  9:        NaN -122.41621 47.10383 0.129372498
    ## 10:  0.4380635  -83.31141 32.62112 0.288559383
    ## 11:        NaN  -94.23901 44.87106 0.143617283
    ## 12:  0.8115269  -86.58400 32.76548 0.448067565
    ## 13:        NaN  -86.28743 40.58895 0.150218238
    ## 14:        NaN  -78.99656 35.45755 0.162529215
    ## 15:  1.4684786  -77.48300 37.32227 0.084837042
    ## 16:        NaN  -93.46252 41.83043 0.173633005
    ## 17:  2.9246829  -76.92148 40.43500 0.229109784
    ## 18:  0.8663505  -98.31427 41.18895 0.227395166
    ## 19:        NaN -114.48602 43.58100 0.203029037
    ## 20:  0.5844788  -89.71108 44.35900 0.125928274
    ## 21:        NaN  -80.52348 38.94249 0.256023446
    ## 22:        NaN  -76.42900 39.16703 0.165656478
    ## 23:  4.9353757 -111.69972 33.53830 0.078748486
    ## 24:  1.2870288  -97.38319 35.48300 0.066096051
    ## 25:  1.9360426 -108.23161 42.80550 0.343226172
    ## 26:        NaN  -91.93350 30.43202 0.207991080
    ## 27:        NaN  -84.81300 37.69132 0.121199593
    ## 28:  0.7287390  -81.77900 28.36194 0.349483770
    ## 29:        NaN -105.63798 39.22305 0.215210418
    ## 30:        NaN  -82.99833 40.35044 0.136287129
    ## 31:  0.2697149  -74.41689 40.27700 0.252960367
    ## 32:  4.6161143 -105.66627 35.00300 0.004262028
    ## 33:  0.8136450  -97.35268 38.33939 0.282646223
    ## 34:        NaN  -99.82250 48.04850 0.396515447
    ## 35:  1.1692211  -72.58800 44.44390 0.093780610
    ## 36:  0.6076094  -89.66850 32.44350 0.428592988
    ## 37:  0.6739065  -72.75506 41.43343 0.105750792
    ## 38:  3.2172261 -116.45795 39.35635 0.514779726
    ## 39:  0.7934400 -111.98868 39.91401 0.404481279
    ## 40:  1.3069242  -99.84202 44.14975 0.499711880
    ## 41: 10.4316511  -86.38300 35.88439 0.185192575
    ## 42:  1.9381201  -75.12899 42.36222 0.740752082
    ## 43:        NaN  -71.43299 41.59700 0.020988246
    ## 44:  1.4576715  -70.93800 42.08504 0.224915499
    ## 45:  0.3755446  -75.46697 39.13291 0.000000000
    ## 46:  0.5769452  -71.46748 43.42260 0.148772844
    ## 47:  1.7506746  -69.63112 44.38306 0.154228360
    ## 48:  3.9431802 -109.45702 45.80547 0.916999296
    ##         eudist     lon_50   lat_50  latlon_dis

``` r
#combine the dataset

c_state <- rbind(station_averages_state, midpoint, fill = TRUE)
```

``` r
library(leaflet)

leaflet(c_state) %>%
  addProviderTiles('CartoDB.Positron') %>%
  addCircles(
    lat = ~lat, lng = ~lon, 
    color = "lightgreen",
    opacity = 1,
    fillOpacity = 1,
    radius=100
)
```

<div id="htmlwidget-f25840f2106eeee944f7" style="width:672px;height:480px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-f25840f2106eeee944f7">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["CartoDB.Positron",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addCircles","args":[[33.8126445959104,29.7089922705314,42.2669724409449,34.4979967776584,41.4632502351834,37.152,35.831000967118,42.1470528169014,31.536,45.5430087241003,33.212,41.4530010638298,36.047,38.137011684518,42.5535839285714,41.3338032388664,41.9856836734694,42.5420088495575,44.3590049261084,39.643,39.4717428571429,32.1669504405286,36.1619871031746,44.3390462962963,32.5159599542334,37.9003206568712,26.5850051546392,37.3069902080783,40.708,40.033,34.3835781584582,39.5509035769829,43.344,31.1829822852081,41.7360101010101,40.0679923664122,41.1173656050955,45.443765323993,35.5930237288136,42.642987628866,41.5329991281604,41.9099972527472,39.6740047984645,43.2040901033973,44.45,45.6980046136102,36.3189948519949,31.0831530984204,43.322,34.283,40.4827108433735,38.7040028195489,35.6,42.3777333333333,47.1038340767172,32.6332458296752,44.859130600572,32.383,40.711,35.5820807424594,37.4,41.691,40.217,40.9615540935673,43.500262987013,44.3590049261084,39,39.3322308300395,33.4668795483061,35.4169039487727,43.0643970117396,30.558,37.578,28.29,39.05,40.28,40.033,35.0029964747356,38.0676310679612,48.39,44.5340018796992,32.3202025316456,41.5099990825688,39.6009961832061,40.219,44.3810077071291,36.009,41.7010332434861,41.597,41.876,39.1329054054054,43.5672086956522,44.533,45.8054722474977],[-118.146523855891,-98.0459922705314,-84.466968503937,-82.7099989258861,-90.5203170272813,-94.4950114942529,-90.646,-121.724052816901,-82.507,-94.0510196292257,-87.616,-87.0060010638298,-79.477,-78.454988315482,-92.4008803571429,-75.7249967611336,-97.4347891156463,-113.766053097345,-89.8370098522168,-79.916,-76.1699571428571,-110.883,-97.0889613095238,-105.540990740741,-92.04097597254,-85.9672290406223,-81.8610051546392,-108.626004895961,-84.027,-74.3501562130177,-103.315653104925,-97.6509035769829,-72.5179990974729,-90.4710035429584,-72.6509797979798,-118.568984732824,-111.966365605096,-98.413442206655,-88.9169966101695,-77.055993814433,-71.2829991281604,-70.729,-75.6060009596929,-71.5024542097489,-68.3667746192893,-110.440038062284,-119.628,-97.6831530984204,-84.688,-80.567,-88.9483614457831,-93.1829934210526,-92.45,-122.870865740741,-122.286834076717,-83.5997190517998,-94.382130600572,-86.3506071794872,-86.375,-79.101,-77.517,-93.566,-76.851,-98.3142660818713,-114.299737012987,-89.8370098522168,-80.274,-76.4166703557312,-111.732899623588,-97.3831921024546,-108.456947705443,-92.099,-84.77,-81.437,-105.510043030031,-83.115,-74.3501562130177,-105.662009400705,-97.275,-100.024,-72.614,-90.0789738924051,-72.8280009174312,-116.005020356234,-111.723,-100.285004816956,-86.52,-74.795,-71.412,-71.021,-75.4669684684685,-71.4325130434783,-69.6672303618711,-108.540024567789],100,null,null,{"interactive":true,"className":"","stroke":true,"color":"lightgreen","weight":5,"opacity":1,"fill":true,"fillColor":"lightgreen","fillOpacity":1},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[26.5850051546392,48.39],"lng":[-122.870865740741,-68.3667746192893]}},"evals":[],"jsHooks":[]}</script>

## Question4: Means of means

Going back to the met dataset.

``` r
met[, state_temp := mean(temp, na.rm = TRUE), by = STATE]
met[, state_wind.sp := mean(wind.sp, na.rm = TRUE), by = STATE]
met[, state_atm.press := mean(atm.press, na.rm = TRUE), by = STATE]

met[, temp_cat := fifelse(
  state_temp < 20, "low-temp", 
  fifelse(state_temp < 25, "mid-temp", "high-temp"))
  ]
```

Let’s make sure that we don’t have NAs

``` r
table(met$temp_cat, useNA = "always")
```

    ## 
    ## high-temp  low-temp  mid-temp      <NA> 
    ##    811126    430794   1135423         0

Now, let’s summarize

``` r
tab <- met[, .(
  N_entries  = .N,
  N_stations = length(unique(USAFID)),
  avg_temp = mean(state_temp),
  avg_wind.sp = mean(state_wind.sp),
  avg_atm.press = mean(state_atm.press)
), by = temp_cat]

knitr::kable(tab)
```

| temp\_cat | N\_entries | N\_stations | avg\_temp | avg\_wind.sp | avg\_atm.press |
| :-------- | ---------: | ----------: | --------: | -----------: | -------------: |
| mid-temp  |    1135423 |         781 |  22.39870 |     2.352673 |       1014.587 |
| high-temp |     811126 |         555 |  27.74436 |     2.512854 |       1013.679 |
| low-temp  |     430794 |         259 |  18.96402 |     2.642823 |             NA |
